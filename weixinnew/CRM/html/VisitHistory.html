<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>历史查询</title>
		<link rel="stylesheet" href="../css/index.css" type="text/css">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	</head>
	<style>
		.form_box {
			background: #FFFFFF;
			width: 100vw;
			height: auto;
			/*margin-bottom: 2rem;*/
			padding: 15px 0;
		}
		
		.form_box div {
			padding: 0 1.25rem;
			height: 4rem;
			line-height: 4rem;
			box-sizing: border-box;
			text-align: center;
			margin: 15px 0;
		}
		.form_box div:first-child {
			margin-top: 0;
		}
		.form_box div:last-child {
			margin-bottom: 0;
		}
		.form_box div input {
			width: 40%;
			height: 3rem;
			line-height: 3rem;
			text-align: center;
			border: 1px solid #ccc;
			margin-top: 0.5rem;
		}
		
		.form_box div input:last-child {
			margin-left: 5%;
		}
		
		.form_box #button button {
			border: none;
			outline: none;
			cursor: pointer;
			width: 85%;
			height: 4rem;
			line-height: 4rem;
			letter-spacing: 5px;
			margin: 0 5% 0.5rem;
			background: #12599B;
			text-align: center;
			color: #fefefe;
		}
		
		.history_list {
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content {
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.history_list h4 {
			margin: 2rem 0;
			text-align: center;
		}
		
		.history_list .Thismonth .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.history_list .Agomonth .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.search_content .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.history_list div ul {
			background: #FFFFFF;
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content ul {
			background: #FFFFFF;
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content ul li {
			border-bottom: 2px solid #E5E5E5;
		}
		
		.history_list div ul li {
			border-bottom: 1px solid #E5E5E5;
		}
		
		ul li div {
			height: 3rem;
			line-height: 3rem;
		}
		
		.monthtitle-name {
			padding: 0 1.25rem;
			box-sizing: border-box;
			font-weight: bold;
			background: #FFFFFF;
			height: 3rem;
			line-height: 3rem;
		}
		
		.companys {
			width: 85%;
			height: 3rem;
			line-height: 3rem;
			text-align: center;
			border: 1px solid #ccc;
			margin-top: 0.5rem;
			padding-left: 15px;
			box-sizing: border-box;
		}
		
		.companys option {
			padding-left: 15px;
			box-sizing: border-box;
		}
	</style>

	<body>
		<div class="content">
			<div class="content_body">
				<!--<div class="title">
					<a href="VisitRecord.php" class="return"><img src="../img/return.png" class="return_img" alt="返回上一页" /></a>
					<span>历史查询</span>
					<a href="VisitHistory.html" class="history"><img src="../img/Refresh.png" class="history_img" /> </a>
				</div>-->
				<div class="form_box">
					<div>
						<input type="text" name="" id="history_start_time" value="" placeholder="开始时间" readonly="readonly" onFocus="WdatePicker({startDate:'%y-%M-{%d-1} %H:%m',dateFmt:'yyyy-MM-dd HH:mm'})" />
						<input type="text" name="" id="history_end_time" value="" placeholder="截止时间" readonly="readonly" onFocus="WdatePicker({startDate:'%y-%M-%d %H:%m',dateFmt:'yyyy-MM-dd HH:mm'})" />
					</div>
					<div>
						<select class="companys">
							<option value="按公司名称查询">按公司名称查询</option>

						</select>
					</div>
					<div id="button">
						<button class="btn_ok">查询</button>
					</div>
				</div>
				<div class="history_list">
					<div class="Thismonth">
						<div class="monthtitle">本月(<span class="Thismonth_num">5</span>)</div>
						<div class="monthtitle-name"><span>李二二</span>的提交拜访</div>
						<ul>
							<!--<li>
								<div class="t1">李二二的提交拜访</div>
								<div><span>拜访对象：</span><span>上海观合医药科技有限公司</span></div>
								<div><span>拜访时间：</span><span>2019-03-22 13：14</span></div>
								<div><span>客户类型：</span><span>临床</span></div>
							</li>-->
						</ul>
					</div>
					<div class="Agomonth">
						<div class="monthtitle">更早以前(<span class="Agomonth_num">40</span>)</div>
						<div class="monthtitle-name"><span>李二二</span>的提交拜访</div>
						<ul>
							<!--<li>
								<div class="t1">李二二的提交拜访</div>
								<div><span>拜访对象：</span><span>上海观合医药科技有限公司</span></div>
								<div><span>拜访时间：</span><span>2019-03-22 13：14</span></div>
								<div><span>客户类型：</span><span>临床</span></div>
							</li>-->

						</ul>
					</div>

				</div>
				<div class="search_content">
					<div class="monthtitle">按时间查询(<span class="Agomonth_num">40</span>)</div>
					<div class="monthtitle-name"><span>李二二</span>的提交拜访</div>
					<ul>

					</ul>
				</div>
			</div>
		</div>
		<div id="success_mao">
			<div class="success_box" style="display:block;">
				<div class="register_right">
					<img src="../img/ku.png" />
				</div>
				<div class="success_information">请使用6-20位字母及数字组合作为用户名</div>
				<form action="">
					<input type="button" value="确定" />
				</form>
			</div>
		</div>
		<script src="../js/jquery-1.11.0.js" type="text/javascript"></script>
		<script src="../My97DatePicker/WdatePicker.js" type="text/javascript"></script>
		<script src="../js/toastr.min.js" type="text/javascript"></script>
		<script src="../js/index.js" type="text/javascript"></script>

		<script>
			$(document).ready(function() {
				var _endTime = new Date();
				var _startTime = new Date(_endTime.getTime() - 7 * 24 * 60 * 60 * 1000);
//				$("#history_start_time").val(history_time(_startTime));
//				$("#history_end_time").val(history_time(_endTime));

				function history_time(_a) {
					var _start_year = _a.getFullYear();
					var _start_month = _a.getMonth() + 1 < 10 ? "0" + (_a.getMonth() + 1) : _a.getMonth() + 1;
					var _start_date = _a.getDate() < 10 ? "0" + (_a.getDate()) : _a.getDate();
					var _start_hour = _a.getHours() < 10 ? "0" + (_a.getHours()) : _a.getHours();
					var _start_minutes = _a.getMinutes() < 10 ? "0" + (_a.getMinutes()) : _a.getMinutes();
					//				var _start_seconds = _a.getSeconds() < 10 ? "0" + (_a.getSeconds()) : _a.getSeconds();
					return _start_year + "-" + _start_month + "-" + _start_date + " " + _start_hour + ":" + _start_minutes;
				};
				var _kight = localStorage.getItem('Knight');
				init(_kight);

				function init(_kight) {
					$('.search_content ul').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/History.php",
						data: {
							State: 'all',
							Knight: _kight
						},
						dataType: "JSON",
						success: function(res) {
							console.log(res)
							$(".search_content").hide();
							if(res.code == 200) {
								$('.Thismonth_num').text(res.this.length);
								$('.Agomonth_num').text(res.last.length);
								var _userinfo = JSON.parse(localStorage.getItem("userInfo"));
								$(".monthtitle-name span").text(_userinfo.TrueName);
								$.each(res.this, function(index, value) {
									let str = `<li>
											<div><span>拜访对象：</span><span>${value.Company}</span></div>
											<div><span>拜访时间：</span><span>${value.StartTime}</span></div>
											<div><span>客户类型：</span><span>${value.CType}</span></div>
											<div><span>联系人：</span><span>${value.Manager}</span>  <span>联系方式：</span><span>${value.Telephone}</span></div>
											<div><span>客户说明：</span><span>${value.Condition}</span></div>
											</li>`;
									$('.Thismonth ul').append(str);
								})
								$.each(res.last, function(index, value) {
									let str = `<li>
											<div><span>拜访对象：</span><span>${value.Company}</span></div>
											<div><span>拜访时间：</span><span>${value.StartTime}</span></div>
											<div><span>客户类型：</span><span>${value.CType}</span></div>
											<div><span>联系人：</span><span>${value.Manager}</span> <span>联系方式：</span><span>${value.Telephone}</span></div>
											<div><span>客户说明：</span><span>${value.Condition}</span></div>
											</li>`;
									$('.Agomonth ul').append(str);
								})
								$.each(res.Account, function(index_1, value_1) {
									let str = `<option value='${value_1}'>${value_1}</option>`;
									$(".companys").append(str);
								})

							} else {
								$('.history_list').html("<h4>没有查询到记录</h4>");
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				$(".btn_ok").on("click", function() {
					var _StartTime = $("#history_start_time").val();
					var _EndTime = $("#history_end_time").val();
					var _Company = $(".companys").val().trim();
					if(_StartTime.length == 0 && _EndTime.length == 0 && _Company == '按公司名称查询') {
						myPlay("请选择查询条件");
					} else if(_StartTime.length == 0 && _EndTime.length == 0 && _Company != '按公司名称查询') {
						searchCom(_Company)
					} else if(_StartTime.length != 0 && _EndTime.length != 0 && _Company == '按公司名称查询') {
						search(_StartTime, _EndTime);
					} else if(_StartTime.length == 0 && _EndTime.length != 0) {
						myPlay("开始时间不能为空");
					} else if(_StartTime.length != 0 && _EndTime.length == 0) {
						myPlay("截止时间不能为空");
					} else {
						searchTimeCom(_StartTime, _EndTime, _Company);
					}
				})
				//按照时间查询
				function search(start, end) {
					$(".history_list").hide();
					$(".search_content").show();
					$('.search_content ul').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/History.php",
						data: {
							State: 'search',
							Knight: _kight,
							StartTime: start,
							EndTime: end
						},
						dataType: "JSON",
						success: function(res) {
							console.log(res)
							if(res.code == '200') {
								$('.Thismonth_num').text(res.data.length);
								var _userinfo = JSON.parse(localStorage.getItem("userInfo"));
								$(".monthtitle-name span").text(_userinfo.TrueName);
								$.each(res.data, function(index1, value1) {
									let str = `<li>
											<div><span>拜访对象：</span><span>${value1.Company}</span></div>
											<div><span>拜访时间：</span><span>${value1.StartTime}</span></div>
											<div><span>客户类型：</span><span>${value1.CType}</span></div>
											<div><span>联系人：</span><span>${value1.Manager}</span>  <span>联系方式：</span><span>${value1.Telephone}</span></div>
											<div><span>客户说明：</span><span>${value1.Condition}</span></div>
											</li>`;
									$('.search_content ul').append(str);
								})
							} else {
								$('.search_content ul').html("<h4>没有查询到记录</h4>");
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				//按照时间公司查询
				function searchTimeCom(start, end, company) {
					$(".history_list").hide();
					$(".search_content").show();
					$('.search_content ul').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/History.php",
						data: {
							State: 'search',
							Knight: _kight,
							StartTime: start,
							EndTime: end,
							Company: company
						},
						dataType: "JSON",
						success: function(res) {
							if(res.code == '200') {
								$('.Thismonth_num').text(res.data.length);
								var _userinfo = JSON.parse(localStorage.getItem("userInfo"));
								$(".monthtitle-name span").text(_userinfo.TrueName);
								$.each(res.data, function(index2, value2) {
									let str = `<li>
											<div><span>拜访对象：</span><span>${value2.Company}</span></div>
											<div><span>拜访时间：</span><span>${value2.StartTime}</span></div>
											<div><span>客户类型：</span><span>${value2.CType}</span></div>
											<div><span>联系人：</span><span>${value2.Manager}</span>  <span>联系方式：</span><span>${value2.Telephone}</span></div>
											<div><span>客户说明：</span><span>${value2.Condition}</span></div>
											</li>`;
									$('.search_content ul').append(str);
								})
							} else {
								$('.search_content ul').html("<h4>没有查询到记录</h4>");
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				//按公司查询
				function searchCom(company) {
					$(".history_list").hide();
					$(".search_content").show();
					$('.search_content ul').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/History.php",
						data: {
							State: 'search',
							Knight: _kight,
							Company: company
						},
						dataType: "JSON",
						success: function(res) {
							$(".search_content").show();
							console.log(res)
							if(res.code == '200') {
								$('.Thismonth_num').text(res.data.length);
								var _userinfo = JSON.parse(localStorage.getItem("userInfo"));
								$(".monthtitle-name span").text(_userinfo.TrueName);
								$.each(res.data, function(index, value) {
									console.log(value.Manager)
									let str1 = `<li>
											<div><span>拜访对象：</span><span>${value.Company}</span></div>
											<div><span>拜访时间：</span><span>${value.StartTime}</span></div>
											<div><span>客户类型：</span><span>${value.CType}</span></div>
											<div><span>联系人：</span><span>${value.Manager}</span><span>联系方式：</span><span>${value.Telephone}</span></div>
											<div><span>客户说明：</span><span>${value.Condition}</span></div>
											</li>`;
									$('.search_content ul').append(str1);
								})
							} else {
								$('.search_content ul').html("<h4>没有查询到记录</h4>");
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
			})
		</script>
	</body>

</html>