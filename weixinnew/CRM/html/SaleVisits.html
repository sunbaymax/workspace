<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>拜访汇总</title>
		<link rel="stylesheet" href="../css/index.css" type="text/css">
		<link rel="stylesheet" href="../css/toastr.min.css" type="text/css">
		<script src="../js/jquery-1.11.0.js"></script>
		<link href="../../../TMS/bootstrap/css/bootstrap.css" rel="stylesheet">
		<script src="../../../TMS/bootstrap/js/bootstrap.js"></script>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	</head>
	<style>
		.form_box {
			padding-top: 15px;
			background: #FFFFFF;
			width: 100vw;
			height: auto;
			/*margin-bottom: 2rem;*/
		}
		
		.form_box div {
			padding: 0 1.25rem;
			height: 4rem;
			line-height: 4rem;
			box-sizing: border-box;
			text-align: center;
		}
		
		.form_box .firstline input {
			width: 40%;
			height: 2.4rem;
			line-height: 2.4rem;
			text-align: center;
			border: 1px solid #ccc;
		}
		
		.form_box .firstline input:last-child {
			margin-left: 2%;
		}
		
		.form_box #button button {
			border: none;
			outline: none;
			cursor: pointer;
			width: 85%;
			height: 3rem;
			line-height: 3rem;
			letter-spacing: 5px;
			margin: 0 5% 0.5rem;
			background: #12599B;
			text-align: center;
			color: #fefefe;
		}
		
		.history_list {
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content {
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.history_list h4 {
			margin: 2rem 0;
			text-align: center;
		}
		
		.history_list .Thismonth .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.search_content {
			margin: 15px 0;
		}
		
		.history_list .Agomonth .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.search_content .monthtitle {
			padding: 0 1.25rem;
			box-sizing: border-box;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.history_list div ul {
			background: #FFFFFF;
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content ul {
			background: #FFFFFF;
			padding: 0 1.25rem;
			box-sizing: border-box;
		}
		
		.search_content ul li {
			border-bottom: 2px solid #E5E5E5;
			margin: 5px 0;
		}
		
		.history_list div ul li {
			border-bottom: 1px solid #E5E5E5;
		}
		
		ul li div {
			height: 3rem;
			line-height: 3rem;
		}
		
		.monthtitle-name {
			padding: 0 1.25rem;
			box-sizing: border-box;
			font-weight: bold;
			background: #FFFFFF;
			height: 3rem;
			line-height: 3rem;
		}
		
		.companys,
		.sales {
			width: 85%;
			height: 2rem;
			line-height: 2rem;
			border: 1px solid #ccc;
			box-sizing: border-box;
		}
		
		.searchs_value li {
			height: 2rem;
			line-height: 2rem;
		}
		
		.searchs_value li button {
			height: 2rem;
			width: 60px;
			background: #00ab6d;
			color: #FFFFFF;
			margin-top: 0.2rem;
			float: right;
			border: none;
		}
		
		.searchs_value li span {
			display: inline-block;
			width: 80%;
			height: 2rem;
			border: 1px solid #000000;
			word-break: keep-all;
			/* 不换行 */
			white-space: nowrap;
			/* 不换行 */
			overflow: hidden;
			/* 内容超出宽度时隐藏超出部分的内容 */
			text-overflow: ellipsis;
		}
		
		table {
			width: 100%;
			height: auto;
			border-collapse: collapse;
			border-spacing: 0;
			border: 1px solid #12599B;
		}
		
		th,
		td {
			border: 1px solid #12599B;
			color: #000000;
			padding: 2px;
			width: 80px;
			height: 2.4rem;
			text-align: center;
		}
		
		th {
			/*background-color: #12599B;*/
			color: #000000;
		}
		
		td {
			font: 14px "微软雅黑";
		}
		
		tbody tr {
			background-color: #FFFFFF;
		}
		
		tbody tr:hover {
			cursor: pointer;
			background-color: #C0CCDA;
		}
		
		#button {
			width: 100%;
			height: 5rem;
			background: #FFFFFF;
		}
		
		.btn_ok {
			margin-left: 10%;
			margin-top: 1rem;
			border: none;
			outline: none;
			cursor: pointer;
			width: 80%;
			height: 3rem;
			line-height: 3rem;
			letter-spacing: 5px;
			/*margin: 0 5% 0.5rem;*/
			background: #12599B;
			text-align: center;
			color: #fefefe;
			border-radius: 5px;
		}
		
		.form-control {
			width: 80%;
			margin: 0 10%;
			box-sizing: border-box;
		}
		
		.form-control input {
			margin-left: 10%;
			font-size: 14px;
		}
		
		.contact-box {
			width: 100%;
			height: 40px;
		}
		
		.contact-box {
			width: 100%;
			background: #FFFFFF;
		}
		
		.hide {
			display: none;
		}
	</style>

	<body>
		<div class="content">
			<div class="content_body">
				<!--<div class="title">
					<a href="javascript:;" class="return"><img src="../img/return.png" class="return_img" alt="返回上一页" /></a>
					<span>拜访汇总</span>
				</div>-->
				<div class="form_box">
					<div class="firstline">
						<input type="text" name="" id="history_start_time" value="" placeholder="开始时间" readonly="readonly" onFocus="WdatePicker({startDate:'%y-%M-{%d-1} %H:%m',dateFmt:'yyyy-MM-dd HH:mm'})" />
						<input type="text" name="" id="history_end_time" value="" placeholder="截止时间" readonly="readonly" onFocus="WdatePicker({startDate:'%y-%M-%d %H:%m',dateFmt:'yyyy-MM-dd HH:mm'})" />
					</div>

				</div>
				<div class="contact-box" style="padding-top: 5px;">
					<div style="padding:5px ;position:relative;">
						<span style="position:absolute;top:5px;overflow:hidden;width:98%;height:32px;">
                     <select name="trains" onchange="qlcTrainS('qlc_zdz1')" class="form-control choose_sales" id="qlc_zdz1" style="height:30px;outline:0;">
                     	
                     </select>
                    </span>
						<span style="position:absolute;top:7px;left:15px;margin-top:1px;margin-left:1px;width:80%;height:28px;border-radius:5px;">
                       <input type="text" name="ccdd" id="qlc_zdz" class="ccdd sales" placeholder="按销售名字查询" style="margin-left: 10%;width:90%;height:24px;border:0pt;border-radius:5px;outline:0;font-size: 14px;">
                     </span>
					</div>
				</div>
				<div class="contact-box" >
					<div style="padding:5px ;position:relative;">
						<span style="position:absolute;top:5px;overflow:hidden;width:98%;height:32px;">
                     <select name="trains" onchange="qlcTrainS('qlc_zdz12')" class="form-control choose_companys" id="qlc_zdz12" style="height:30px;outline:0;"></select>
                    </span>
						<span style="position:absolute;top:7px;left:15px;margin-top:1px;margin-left:1px;width:80%;height:28px;border-radius:5px;">
                       <input type="text" name="ccdd" id="qlc_zdz" class="ccdd companys" placeholder="按公司查询" style="margin-left: 10%;width:90%;height:24px;border:0pt;border-radius:5px;outline:0;font-size: 14px;">
                     </span>
					</div>

				</div>
				<div id="button" style="margin-bottom: 15px;">
					<button class="btn_ok">查询</button>
				</div>

				<div class="search_content ">
					<table>
						<thead>
							<tr>
								<th>姓名</th>
								<th>公司数目</th>
								<th>拜访次数</th>
							</tr>
						</thead>
						<tbody>
							<!--<tr>
								<td>王杰</td>
								<td>男</td>
								<td>19</td>
							</tr>-->

						</tbody>
					</table>
				</div>

			</div>
		</div>
		<div id="success_mao">
			<div class="success_box" style="display:block;">
				<div class="register_right">
					<img src="../img/ku.png" />
				</div>
				<div class="success_information">请使用6-20位字母及数字组合作为用户名</div>
				<form action="">
					<input type="button" value="确定" />
				</form>
			</div>
		</div>
		<script src="../js/jquery-1.11.0.js" type="text/javascript"></script>
		<script src="../My97DatePicker/WdatePicker.js" type="text/javascript"></script>
		<script src="../js/toastr.min.js" type="text/javascript"></script>
		<script src="../js/index.js" type="text/javascript"></script>

		<script>
			<!--将select的值赋给input框-->
			function qlcTrainS(idName) {
				var arrValue = document.getElementById(idName).options[document.getElementById(idName).selectedIndex].value;
				$("#" + idName + "").parent('span').next('span').children('input.ccdd').val(arrValue)
			}
		</script>
		<script>
			$(document).ready(function() {
				var isnull = true;
				var _endTime = new Date();
				var _startTime = new Date(_endTime.getTime() - 24 * 60 * 60 * 1000);
				$("#history_start_time").val(history_time(_startTime));
				$("#history_end_time").val(history_time(_endTime));

				function history_time(_a) {
					var _start_year = _a.getFullYear();
					var _start_month = _a.getMonth() + 1 < 10 ? "0" + (_a.getMonth() + 1) : _a.getMonth() + 1;
					var _start_date = _a.getDate() < 10 ? "0" + (_a.getDate()) : _a.getDate();
					var _start_hour = _a.getHours() < 10 ? "0" + (_a.getHours()) : _a.getHours();
					var _start_minutes = _a.getMinutes() < 10 ? "0" + (_a.getMinutes()) : _a.getMinutes();
					//				var _start_seconds = _a.getSeconds() < 10 ? "0" + (_a.getSeconds()) : _a.getSeconds();
					return _start_year + "-" + _start_month + "-" + _start_date + " " + _start_hour + ":" + _start_minutes;
				};
				var _kight = localStorage.getItem('Knight');

				init();

				function init(_kight) {
					$('.search_content table tbody').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'all',
							Knight: _kight
						},
						dataType: "JSON",
						
						success: function(res) {
							if(res.code == '200') {
								$('.search_content table').fadeIn();
								$.each(res.data, function(index, value) {
									let str = `<tr><td>${value.SaleName}</td><td>${value.count}</td><td>${value.sum}</td></tr>`;
									$('.search_content table tbody').append(str);
								})
							} else {
								$('.search_content table').fadeOut();
								toastr.error('该时间段：' + res.msg);
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				//监听录入的公司名称
				$('.companys').on('input propertychange', function() {
					var inputcompany = $(this).val();
					if(escape(inputcompany).indexOf("%u") < 0) {} else {
						AccordCompany(inputcompany);
					}
				});
				//监听录入的销售姓名
				$('.sales').bind('input propertychange', function() {
					var inputsale = $(this).val();
					if(escape(inputsale).indexOf("%u") < 0) {} else {
						AccordSale(inputsale);
					}
				});

				function AccordCompany(keyword) {
					$('.choose_companys').empty();
					var str = `<option value ='请进行下拉选择'>---------请进行选择--------</option> `;
					$('.choose_companys').append(str);
					$.ajax({
						type: "post",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'Company',
							Company: keyword
						},
						dataType: "JSON",
						success: function(res) {
							if(res.code == 400) {
								if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到相关信息");
								}
								return false;
							} else {
								$.each(res.data, function(i, val) {
									let str = `  <option value ='${val.Company}'>${val.Company}</option> `;
									$('.choose_companys').append(str);
								})

							}

						},
						error: function(err) {

						}
					});
				}

				function AccordSale(keyword) {
					$('.choose_sales').html('');
					let str1 = `<option value ='请进行选择'>---------请进行选择--------</option> `;
					$('.choose_sales').append(str1);
					$.ajax({
						type: "post",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'Name',
							Name: keyword
						},
						dataType: "JSON",
						success: function(res) {
							console.log(res);
							if(res.code == '200') {
								var _data = res.data;
								
								$.each(_data, function(index1, value1) {
									let strsale = ` <option value ='${value1.SaleName}'>${value1.SaleName}</option> `;
									$('.choose_sales').append(strsale);
								})

							} else {
								if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到相关信息");
								}
								return false;

							}

						},
						error: function(err) {

						}
					});
				}
				$(".btn_ok").on("click", function() {
					var _StartTime = $("#history_start_time").val();
					var _EndTime = $("#history_end_time").val();
					var _Company = $(".companys").val().trim();
					var _Sale = $(".sales").val().trim();
					if(_StartTime.length == 0 && _EndTime.length == 0 && _Company == '' && _Sale == '') {
						myPlay("请选择查询条件");
					} else if(_StartTime.length != 0 && _EndTime.length != 0 && _Company != '' && _Sale == '') {
						searchCom(_StartTime, _EndTime, _Company)
					} else if(_StartTime.length != 0 && _EndTime.length != 0 && _Company == '' && _Sale != '') {
						searchSale(_StartTime, _EndTime, _Sale);
					} else if(_StartTime.length == 0 && _EndTime.length != 0) {
						myPlay("开始时间不能为空");
					} else if(_StartTime.length != 0 && _EndTime.length == 0) {
						myPlay("截止时间不能为空");
					} else if(_StartTime.length != 0 && _EndTime.length != 0 && _Company == '' && _Sale == '') {
						search(_StartTime, _EndTime);
					} else {
						searchall(_StartTime, _EndTime, _Company, _Sale);
					}
				})

				//按照时间查询
				function search(start, end) {
					$('.search_content table tbody').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'all',
							StartTime: start,
							EndTime: end
						},
						dataType: "JSON",
						success: function(res) {
							if(res.code == '200') {
								$('.search_content table').fadeIn();
								$.each(res.data, function(index, value) {
									let str = `<tr><td>${value.SaleName}</td><td>${value.count}</td><td>${value.sum}</td></tr>`;
									$('.search_content table tbody').append(str);
								})
							} else {
								$('.search_content table').fadeOut();
									if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到记录");
								}
								return false;
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				//按照时间查询
				function searchSale(start, end, sale) {
					$('.search_content table tbody').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'all',
							StartTime: start,
							EndTime: end,
							Name: sale
						},
						dataType: "JSON",
						success: function(res) {
							if(res.code == '200') {
								$('.search_content table').fadeIn();
								$.each(res.data, function(index, value) {
									let str = `<tr><td>${value.SaleName}</td><td>${value.count}</td><td>${value.sum}</td></tr>`;
									$('.search_content table tbody').append(str);
								})
							} else {
								$('.search_content table').fadeOut();
								if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到记录");
								}
								return false;
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				//按照时间公司查询
				function searchCom(starttime, endtime, company) {
					$('.search_content table tbody').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'all',
							StartTime: starttime,
							EndTime: endtime,
							Company: company
						},
						dataType: "JSON",
						success: function(res) {
							if(res.code == '200') {
								$.each(res.data, function(index, value) {
									$('.search_content table').fadeIn();
									let str = `<tr><td>${value.SaleName}</td><td>${value.count}</td><td>${value.sum}</td></tr>`;
									$('.search_content table tbody').append(str);
								})
							} else {
								$('.search_content table').fadeOut();
								if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到记录");
								}
								return false;
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}

				function searchall(starttime, endtime, company, sale) {
					$('.search_content table tbody').html('');
					$.ajax({
						type: "POST",
						url: "http://out.ccsc58.cc/DATA_PORT_CRM_1.01/Summary.php",
						data: {
							State: 'all',
							StartTime: starttime,
							EndTime: endtime,
							Company: company,
							Name: sale
						},
						dataType: "JSON",
						success: function(res) {
							console.log(res)
							if(res.code == '200') {
								$('.search_content table').fadeIn();
								$.each(res.data, function(index, value) {
									let str = `<tr><td>${value.SaleName}</td><td>${value.count}</td><td>${value.sum}</td></tr>`;
									$('.search_content table tbody').append(str);
								})
							} else {
								$('.search_content table').fadeOut();
								if(isnull) {
									isnull = false;
									setTimeout(function() {
										isnull = true
									}, 3000);
									toastr.error("没有查询到记录");
								}
								return false;
							}
						},
						error: function(err) {
							//console.log(err)
						}
					});
				}
				$(".return_img").on("click", function() {
					window.location.href = 'Person.html';
				})
			})
		</script>
	</body>

</html>